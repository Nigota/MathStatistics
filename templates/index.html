<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ спектроскопии пациентов</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: white;
        }
        .chart-container {
            width: 900px;
            height: 650px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <h1>Среднее значение волнового числа у пациентов</h1>
    <div class="subtitle">со среднеквадратичным отклонением</div>

    <div id="mainChart" class="chart-container"></div>

    <script>
        const dataset = {{ dataset|tojson|safe }}


        // Подготовка данных
        function prepareData(data) {
            const healthy = data.filter(row => row.health === 1);
            const unhealthy = data.filter(row => row.health === 0);

            const wavenumber = healthy.map(row => row.wavenumber);

            function calculateStats(rows) {
                const patientCols = Object.keys(rows[0]).filter(key => key.startsWith('patient'));

                const means = [];
                const stds = [];
                const allValues = [];

                for (let i = 0; i < rows.length; i++) {
                    const values = patientCols.map(col => rows[i][col]);
                    const mean = values.reduce((a, b) => a + b, 0) / values.length;
                    const std = Math.sqrt(values.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / values.length);

                    means.push(mean);
                    stds.push(std);
                    allValues.push(...values);
                }

                return { means, stds, allValues };
            }

            const healthyStats = calculateStats(healthy);
            const unhealthyStats = calculateStats(unhealthy);

            // Определяем границы для оси Y
            const maxValue = Math.max(
                ...healthyStats.means,
                ...unhealthyStats.means,
                ...healthyStats.means.map((m, i) => m + healthyStats.stds[i]),
                ...unhealthyStats.means.map((m, i) => m + unhealthyStats.stds[i])
            );
            const minValue = Math.min(
                ...healthyStats.means,
                ...unhealthyStats.means,
                ...healthyStats.means.map((m, i) => m - healthyStats.stds[i]),
                ...unhealthyStats.means.map((m, i) => m - unhealthyStats.stds[i])
            );
            const padding = (maxValue - minValue) * 0.05;

            return {
                wavenumber,
                healthyMeans: healthyStats.means,
                healthyStds: healthyStats.stds,
                unhealthyMeans: unhealthyStats.means,
                unhealthyStds: unhealthyStats.stds,
                yRange: [minValue - padding, maxValue + padding]
            };
        }

        // Подготавливаем данные
        const data = prepareData(dataset);
        const plotDiv = document.getElementById('mainChart');

        // Настройки графика
        const layout = {
            xaxis: {
                title: 'Волновое число (cm⁻¹)',
                range: [Math.min(...data.wavenumber), Math.max(...data.wavenumber)],
                showgrid: true,
                gridcolor: '#eee',
                zeroline: true,
                zerolinecolor: '#aaa'
            },
            yaxis: {
                title: 'Интенсивность',
                range: data.yRange,
                showgrid: true,
                gridcolor: '#eee',
                zeroline: true,
                zerolinecolor: '#aaa'
            },
            legend: {
                orientation: 'h',
                y: -0.25,
                font: {
                    size: 12
                }
            },
            margin: {
                l: 70,
                r: 40,
                b: 80,
                t: 60,
                pad: 10
            },
            plot_bgcolor: 'white',
            paper_bgcolor: 'white',
            hovermode: 'x unified'
        };

        // Создаем начальное состояние графика
        const initialTraces = [
            // Здоровые среднее (0)
            {
                x: data.wavenumber,
                y: new Array(data.wavenumber.length).fill(data.yRange[0]),
                name: 'Здоровые (среднее)',
                line: { color: '#1f77b4', width: 3 },
                mode: 'lines'
            },
            // Здоровые +СКО (1)
            {
                x: data.wavenumber,
                y: new Array(data.wavenumber.length).fill(data.yRange[0]),
                name: 'Здоровые +СКО',
                line: { color: '#1f77b4', width: 1, dash: 'dot' },
                mode: 'lines',
                showlegend: true,
                hoverinfo: 'none'
            },
            // Здоровые -СКО (2)
            {
                x: data.wavenumber,
                y: new Array(data.wavenumber.length).fill(data.yRange[0]),
                line: { color: '#1f77b4', width: 1, dash: 'dot' },
                mode: 'lines',
                showlegend: false,
                hoverinfo: 'none',
                fill: 'tonexty',
                fillcolor: 'rgba(31, 119, 180, 0.15)'
            },
            // Больные среднее (3)
            {
                x: data.wavenumber,
                y: new Array(data.wavenumber.length).fill(data.yRange[0]),
                name: 'Больные (среднее)',
                line: { color: '#ff7f0e', width: 3 },
                mode: 'lines'
            },
            // Больные +СКО (4)
            {
                x: data.wavenumber,
                y: new Array(data.wavenumber.length).fill(data.yRange[0]),
                name: 'Больные +СКО',
                line: { color: '#ff7f0e', width: 1, dash: 'dot' },
                mode: 'lines',
                showlegend: true,
                hoverinfo: 'none'
            },
            // Больные -СКО (5)
            {
                x: data.wavenumber,
                y: new Array(data.wavenumber.length).fill(data.yRange[0]),
                line: { color: '#ff7f0e', width: 1, dash: 'dot' },
                mode: 'lines',
                showlegend: false,
                hoverinfo: 'none',
                fill: 'tonexty',
                fillcolor: 'rgba(255, 127, 14, 0.15)'
            }
        ];

        Plotly.newPlot(plotDiv, initialTraces, layout);

        // Экспоненциальная функция для easing (быстро в начале, медленно в конце)
        function exponentialEasing(t) {
            return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
        }

        // Анимация
        function animate() {
            const totalDuration = 2500; // 2.5 секунда общее время
            const startTime = Date.now();

            // Состояние анимации
            let currentTraces = JSON.parse(JSON.stringify(initialTraces));

            function animateFrame() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(1, elapsed / totalDuration);
                const easedProgress = exponentialEasing(progress);

                // Разделяем анимацию на фазы
                if (progress <= 0.5) {
                    // Фаза 1: Подъем средних линий (0-0.5s)
                    const phaseProgress = progress * 2;
                    const easedPhaseProgress = exponentialEasing(phaseProgress);

                    for (let i = 0; i < data.wavenumber.length; i++) {
                        // Здоровые
                        currentTraces[0].y[i] = data.yRange[0] +
                            (data.healthyMeans[i] - data.yRange[0]) * easedPhaseProgress;

                        // Больные
                        currentTraces[3].y[i] = data.yRange[0] +
                            (data.unhealthyMeans[i] - data.yRange[0]) * easedPhaseProgress;
                    }
                } else {
                    // Фаза 2: Построение СКО (0.5-1s)
                    const phaseProgress = (progress - 0.5) * 2;
                    const easedPhaseProgress = exponentialEasing(phaseProgress);

                    for (let i = 0; i < data.wavenumber.length; i++) {
                        // Здоровые +СКО
                        currentTraces[1].y[i] = data.healthyMeans[i] +
                            data.healthyStds[i] * easedPhaseProgress;

                        // Здоровые -СКО
                        currentTraces[2].y[i] = data.healthyMeans[i] -
                            data.healthyStds[i] * easedPhaseProgress;

                        // Больные +СКО (с небольшой задержкой)
                        if (phaseProgress > 0.2) {
                            const patientProgress = (phaseProgress - 0.2) / 0.8;
                            const easedPatientProgress = exponentialEasing(patientProgress);

                            currentTraces[4].y[i] = data.unhealthyMeans[i] +
                                data.unhealthyStds[i] * easedPatientProgress;

                            currentTraces[5].y[i] = data.unhealthyMeans[i] -
                                data.unhealthyStds[i] * easedPatientProgress;
                        }
                    }
                }

                // Обновляем график
                Plotly.animate(plotDiv, {
                    data: currentTraces,
                    traces: [0, 1, 2, 3, 4, 5],
                    layout: {}
                }, {
                    transition: { duration: 0 },
                    frame: { duration: 0, redraw: true }
                });

                if (progress < 1) {
                    requestAnimationFrame(animateFrame);
                }
            }

            animateFrame();
        }

        // Запускаем анимацию
        setTimeout(animate, 500);
    </script>
</body>
</html>